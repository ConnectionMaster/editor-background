fs = require 'fs'
request = require 'request'
itag_formats = require './formats.js'
{Emitter} = require 'event-kit'
mp4 = require './iso_boxer.js'

class YouTube

  
  INFO_URL = 'https://www.youtube.com/api_video_info?html5=1&c=WEB&cplayer=UNIPLAYER&cver=html5&el=embedded&video_id='
  VIDEO_EURL = 'https://youtube.googleapis.com/v/'
  HEADER_SIZE = 438
  
  ytid = ''
  videoInfo = {}
  formats = []
  duration = 0

  constructor:(url)->
    @ytid = @getYTId url
    @emitter = new Emitter
    console.log 'youtube lib initialized',@ytid

  getYTId: (url) ->
    if url!=''
      ytreg = /// (?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)
      |youtu\.be\/)([^"&?\/ ]{11}) ///i
      ytidregres=ytreg.exec(url)
      if ytidregres?.length>0
        ytid=ytidregres[1]



  
  parseTime: (time) ->
    console.log 'parseTime',time
    timeRegexp = /(?:(\d+)h)?(?:(\d+)m(?!s))?(?:(\d+)s)?(?:(\d+)(?:ms)?)?/
    result = timeRegexp.exec(time.toString())
    hours  = result[1] || 0
    mins   = result[2] || 0
    secs   = result[3] || 0
    ms     = result[4] || 0
    res = hours * 3600000 + mins * 60000 + secs * 1000 + parseInt(ms, 10)
    console.log 'res',res
    res*100 # for .00


  on:(event,func)->
    @emitter.on event,func


  getMap: (map)->
    streamMap = map.split(',')
    streams = []
    for map,i in streamMap
      streamData = map.split('&')
      for data in streamData 
        [key,value]=data.split('=')
        if !streams[i]? then streams[i]={}
        streams[i][key]=unescape(value)
    streams


  getVideoInfo:(url,next)->
    if url?
      @ytid = @getYTId url
    if @ytid ==  '' then return
    reqUrl = INFO_URL+@ytid
    console.log 'reqUrl',reqUrl
    request reqUrl,(err,response,body)=>
      if err?
        console.log 'error',err
        return
      info = body.split('&')

      temp = {}
      for param in info
        [key,value] = param.split('=')
        value = unescape(value)

        if !Array.isArray(temp[key]) and temp[key]?
          old = temp[key]
          temp[key] =  []
          temp[key].push old
        
        if Array.isArray temp[key]
          temp[key].push unescape(value)
        
        if not temp[key]?
          temp[key] = value

      if temp.status!='ok'
        console.log 'error',temp.reason
        return

      @basicStreams = @getMap temp.url_encoded_fmt_stream_map
      @adaptiveStreams = @getMap temp.adaptive_fmts

      console.log temp
      dashmpd = temp.dashmpd.split(',')
      console.log dashmpd

      ###
      flashDataUri = "iurl=https%3A%2F%2Fi.ytimg.com%2Fvi%2FJdNSr81tI6g%2Fhqdefault.jpg&amp;index=0&amp;length_seconds=61&amp;allow_embed=1&amp;fflags=player_legacy_behavior%3Dtrue%26enable_audio_cast%3Dtrue&amp;video_id=JdNSr81tI6g&amp;player_error_log_fraction=1.0&amp;cbr=Chrome&amp;iurlmaxres_webp=https%3A%2F%2Fi.ytimg.com%2Fvi_webp%2FJdNSr81tI6g%2Fmaxresdefault.webp&amp;innertube_api_version=v1&amp;eventid=k6xhVdjFJJKsd-vBgsgI&amp;iurlmq_webp=https%3A%2F%2Fi.ytimg.com%2Fvi_webp%2FJdNSr81tI6g%2Fmqdefault.webp&amp;iurlhq=https%3A%2F%2Fi.ytimg.com%2Fvi%2FJdNSr81tI6g%2Fhqdefault.jpg&amp;el=embedded&amp;c=WEB&amp;cbrver=43.0.2357.65&amp;enablejsapi=1&amp;iurlhq_webp=https%3A%2F%2Fi.ytimg.com%2Fvi_webp%2FJdNSr81tI6g%2Fhqdefault.webp&amp;rel=1&amp;host_language=pl&amp;watch_xlb=https%3A%2F%2Fs.ytimg.com%2Fyts%2Fxlbbin%2Fwatch-strings-pl_PL-vflgvO53-.xlb&amp;gapi_hint_params=m%3B%2F_%2Fscs%2Fabc-static%2F_%2Fjs%2Fk%3Dgapi.gapi.en.dPxK-DAj_pE.O%2Fm%3D__features__%2Fam%3DAAQ%2Frt%3Dj%2Fd%3D1%2Frs%3DAItRSTN0fuoBkyFaoHWfzWWLct0BxZgQSQ&amp;clipboard_swf=https%3A%2F%2Fs.ytimg.com%2Fyts%2Fswfbin%2Fplayer-vflwYITrz%2Fclipboard_polyfill.swf&amp;ssl=1&amp;apiary_host&amp;innertube_api_key=AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8&amp;cos=X11&amp;iurlsd_webp=https%3A%2F%2Fi.ytimg.com%2Fvi_webp%2FJdNSr81tI6g%2Fsddefault.webp&amp;apiary_host_firstparty&amp;avg_rating=5.0&amp;iurlmq=https%3A%2F%2Fi.ytimg.com%2Fvi%2FJdNSr81tI6g%2Fmqdefault.jpg&amp;allow_ratings=1&amp;hl=pl_PL&amp;iurlsd=https%3A%2F%2Fi.ytimg.com%2Fvi%2FJdNSr81tI6g%2Fsddefault.jpg&amp;is_html5_mobile_device=false&amp;title=4K%20Green%20Plasma%20Ripple%20Swamp%20Effect%20HD%20Background%20Animation&amp;view_count=7292&amp;fexp=901803%2C913445%2C9408142%2C9408289%2C9408710%2C9413503%2C9415304%2C948124%2C952612&amp;iurlmaxres=https%3A%2F%2Fi.ytimg.com%2Fvi%2FJdNSr81tI6g%2Fmaxresdefault.jpg&amp;idpj=-8&amp;cr=PL&amp;iurl_webp=https%3A%2F%2Fi.ytimg.com%2Fvi_webp%2FJdNSr81tI6g%2Fhqdefault.webp&amp;innertube_context_client_version=20150521&amp;ldpj=-11&amp;legacy_behavior=1&amp;playerapiid=player_uid_484658883_1&amp;afv_ad_tag=http%3A%2F%2Fgoogleads.g.doubleclick.net%2Fpagead%2Fads%3Fad_type%3Dtext_image_flash%26channel%3Dyt_mpvid_aDfJ7Q6W60JPrsrt%252Byt_cid_8211322%252Bivp%252Byt_no_ap%252Bytdevice_1%252Byt_no_cp%252Bafv_user_id_ilPIl-SwFbtsoH8WLnvlfA%252Bafv_user_dvdangor2011%252Bytel_embedded%252Bytps_default%252BVertical_3%252BVertical_36%252BVertical_43%252BVertical_211%252BVertical_299%252BVertical_613%252Bafv_overlay%252Binvideo_overlay_480x70_cat1%26client%3Dca-pub-6219811747049371%26dbp%3DChZvV0NyQlBoVWJIYzVFMUpEdGdkb1FnEAE%26description_url%3Dhttp%253A%252F%252Fwww.youtube.com%252Fvideo%252FJdNSr81tI6g%26eid%3D56702370%26hl%3Dpl%26host%3Dca-host-pub-2582020522081927%26ht_id%3D6320636%26lact%3D31%26loeid%3D901803%2C913445%2C9408289%26sdki%3D5%26url%3Dhttp%253A%252F%252Fwww.youtube.com%252Fvideo%252FJdNSr81tI6g%26ytdevice%3D1%26yt_pt%3DAPb3F28wib6u2DjLZAy1z3mmhrzBfSuESVKTQjkRWSakVA-ZbGf6EKTnKXsfhgwBxONKBi6Or7M2lO-U0h60nsgfgpYQsR_UP9BGcsi6rCzQdvGnwdw1Fn79XBWjjTopVZLh4R4Bkpny621wVwtEUffV42j0HOisoV2ai4T0DQ&amp;pltype=content&amp;allowed_ads=%5B8%2C%201%2C%202%2C%2010%2C%200%5D&amp;of=oWCrBPhUbHc5E1JDtgdoQg&amp;core_dbp=ChZvV0NyQlBoVWJIYzVFMUpEdGdkb1FnEAE&amp;status=ok&amp;afv=True&amp;url_encoded_fmt_stream_map=url%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D60.023%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DJYA7K-8_ynE%2526mime%253Dvideo%25252Fmp4%2526ratebypass%253Dyes%2526key%253Dyt5%2526itag%253D22%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253D9E9E53B64AEB2490D15E17C0847E71135EE969B4.37C588E67C72F59746E43A82A2352C21AAB143DB%2526sparams%253Ddur%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Cratebypass%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26type%3Dvideo%252Fmp4%253B%2Bcodecs%253D%2522avc1.64001F%252C%2Bmp4a.40.2%2522%26fallback_host%3Dtc.v12.cache7.googlevideo.com%26itag%3D22%26quality%3Dhd720%2Curl%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D0.000%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DJYA7K-8_ynE%2526mime%253Dvideo%25252Fwebm%2526ratebypass%253Dyes%2526key%253Dyt5%2526itag%253D43%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253D34A1856276A80756BDB42EE4F0127F51999927F1.354B5CEC17D777A11666E6F19F1007A0BEEFDF81%2526sparams%253Ddur%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Cratebypass%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26type%3Dvideo%252Fwebm%253B%2Bcodecs%253D%2522vp8.0%252C%2Bvorbis%2522%26fallback_host%3Dtc.v3.cache4.googlevideo.com%26itag%3D43%26quality%3Dmedium%2Curl%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D60.023%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DJYA7K-8_ynE%2526mime%253Dvideo%25252Fmp4%2526ratebypass%253Dyes%2526key%253Dyt5%2526itag%253D18%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253D1257A1BBFA30EAC4A3893FA5EAEB81DAE6B36B11.06BD4980782B7B79A80943BE69CD04D2D4B3DCE2%2526sparams%253Ddur%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Cratebypass%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26type%3Dvideo%252Fmp4%253B%2Bcodecs%253D%2522avc1.42001E%252C%2Bmp4a.40.2%2522%26fallback_host%3Dtc.v18.cache4.googlevideo.com%26itag%3D18%26quality%3Dmedium%2Curl%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526ip%253D89.228.194.99%2526expire%253D1432486131%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D60.003%2526requiressl%253Dyes%2526initcwndbps%253D1538750%2526sver%253D3%2526mime%253Dvideo%25252Fx-flv%2526source%253Dyoutube%2526key%253Dyt5%2526itag%253D5%2526sparams%253Ddur%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526mt%253D1432464497%2526upn%253DJYA7K-8_ynE%2526ipbits%253D0%2526signature%253D1034832A07E5EFFEC9296EA50F3D85F478847D8A.9492A1E33955DEBF780F7E72415A3B0F5E1DEECF%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%26type%3Dvideo%252Fx-flv%26fallback_host%3Dtc.v9.cache7.googlevideo.com%26itag%3D5%26quality%3Dsmall%2Curl%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526ip%253D89.228.194.99%2526expire%253D1432486131%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D60.186%2526requiressl%253Dyes%2526initcwndbps%253D1538750%2526sver%253D3%2526mime%253Dvideo%25252F3gpp%2526source%253Dyoutube%2526key%253Dyt5%2526itag%253D36%2526sparams%253Ddur%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526mt%253D1432464497%2526upn%253DJYA7K-8_ynE%2526ipbits%253D0%2526signature%253D58C1C34323F772B89DECC59F9C9B540436059296.CAF6E8EEECD016A4304A2B83465B5D3942451341%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%26type%3Dvideo%252F3gpp%253B%2Bcodecs%253D%2522mp4v.20.3%252C%2Bmp4a.40.2%2522%26fallback_host%3Dtc.v19.cache8.googlevideo.com%26itag%3D36%26quality%3Dsmall%2Curl%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526ip%253D89.228.194.99%2526expire%253D1432486131%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D60.186%2526requiressl%253Dyes%2526initcwndbps%253D1538750%2526sver%253D3%2526mime%253Dvideo%25252F3gpp%2526source%253Dyoutube%2526key%253Dyt5%2526itag%253D17%2526sparams%253Ddur%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526mt%253D1432464497%2526upn%253DJYA7K-8_ynE%2526ipbits%253D0%2526signature%253D3A1DC855EB55E5F7E8341430A5DE4B64F790ABE4.5EC89B8D90CADC3D0E0CBDE016B2208A3D8DCE0B%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%26type%3Dvideo%252F3gpp%253B%2Bcodecs%253D%2522mp4v.20.3%252C%2Bmp4a.40.2%2522%26fallback_host%3Dtc.v22.cache2.googlevideo.com%26itag%3D17%26quality%3Dsmall&amp;plid=AAUW0aOPr33jm_hI&amp;fade_in_start_milliseconds=-3000&amp;keywords=4k%20free%20footage%2C4k%2060fps%2C60fps%2C4k%20background%20animation%2CBackground%20video%2C4k%20free%20background%2Cbest%204k%20animation%2Cbest%204k%20background%2Cbest%204k%20effects%2Cbest%204k%20free%2Cfree%2Canimation%2Cbackground%2CFree%20video%2CCG%20background%2CGreen%20Screen%2CVFX%2Cvideo%20footage%2Croyalty%20free%2Canimation%20background%2C4k%20animation%2C4k%20resolution%2Ccgi%2Ceffect%2CULTRA%20HD%2CUHD%2CLight%20Leaks%2CBokeh%2Cgreen%20screen%2Cbackground%20video%2Cafter%20effects&amp;video_verticals=%5B211%2C%203%2C%2043%5D&amp;sffb=True&amp;ad_logging_flag=1&amp;has_cc=False&amp;dashmpd=https%3A%2F%2Fmanifest.googlevideo.com%2Fapi%2Fmanifest%2Fdash%2Fmm%2F31%2Fplayback_host%2Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%2Fpl%2F18%2Fexpire%2F1432486131%2Fid%2Fo-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2Fsource%2Fyoutube%2Fas%2Ffmp4_audio_clear%252Cwebm_audio_clear%252Cfmp4_sd_hd_clear%252Cwebm_sd_hd_clear%252Cwebm2_sd_hd_clear%2Frequiressl%2Fyes%2Fsver%2F3%2Fip%2F89.228.194.99%2Fkey%2Fyt5%2Fitag%2F0%2Fsparams%2Fas%252Cid%252Cip%252Cipbits%252Citag%252Cmm%252Cms%252Cmv%252Cpl%252Cplayback_host%252Crequiressl%252Csource%252Cexpire%2Fmt%2F1432464497%2Fupn%2FgdVc6iQ4muI%2Fipbits%2F0%2Fsignature%2FA4F647409060205095B6F63DCA75AC5FB341C8A7.B3AE8285A2A3658D2FF81DF3824F60A0A50F85C9%2Fmv%2Fm%2Fms%2Fau%2Ffexp%2F3300109%252C3300131%252C3300137%252C3312210%252C3312381%252C901803%252C913445%252C9408142%252C9408289%252C9408710%252C9413503%252C9415304%252C948124%252C952612&amp;gut_tag=%2F4061%2Fytunknown%2Fmain&amp;oid=qUEHMaDotk0euYX4vZ-0BA&amp;atc=a%3D3%26b%3DIMabiEtC5fbw0AT2xxtx8LBJ2Io%26c%3D1432464531%26d%3D1%26e%3DJdNSr81tI6g%26c3a%3D21%26c1a%3D1%26hh%3DQGQVmiiD9wq7yN2N_kOdkH6sN6A&amp;instream_long=False&amp;pyv_in_related_cafe_experiment_id=56702372&amp;csi_page_type=embed&amp;rvs=author%3DDiscovery%2BSpace%2BVideos%26endscreen_autoplay_session_data%3Dfeature%253Drelated-auto%2526autonav%253D1%2526playnext%253D0%26id%3DtMVDWvHlrRc%26title%3D1%2BHOUR%2Bof%2BAMAZING%2BHQ%2BSPACE%2BVIDEO%2B-%2BThe%2BBEST%2Bof%2BDiscovery%2BSpace%26session_data%3Ditct%253DMgllbmRzY3JlZW5IqMe06_zV1Okl%26length_seconds%3D3870%2Cauthor%3DAA%2BVFX%26id%3DCxCNQytg8pk%26length_seconds%3D60%26title%3D4K%2BColorful%2BRainbow%2BParticle%2BSpread%2BShine%2BUHD%2BBackground%2BAnimation%26session_data%3Ditct%253DMgllbmRzY3JlZW5IqMe06_zV1Okl%26iurlhq_webp%3D%252F%252Fi.ytimg.com%252Fvi_webp%252FCxCNQytg8pk%252Fhqdefault.webp%26iurlmq_webp%3D%252F%252Fi.ytimg.com%252Fvi_webp%252FCxCNQytg8pk%252Fmqdefault.webp%2Cauthor%3DAA%2BVFX%26id%3DYUDes_czZ3M%26length_seconds%3D60%26title%3D4K%2BSunset%2BGradient%2BColored%2BBlue%2BStreaks%2BShow%2BUHD%2BHD%2BBackground%2BAnimation%26session_data%3Ditct%253DMgllbmRzY3JlZW5IqMe06_zV1Okl%26iurlhq_webp%3D%252F%252Fi.ytimg.com%252Fvi_webp%252FYUDes_czZ3M%252Fhqdefault.webp%26iurlmq_webp%3D%252F%252Fi.ytimg.com%252Fvi_webp%252FYUDes_czZ3M%252Fmqdefault.webp%2Cauthor%3DAA%2BVFX%26title%3D60FPS%2B4K%2BCirclular%2BSpace%2BStage%2BShow%2BRoyalty%2BFree%2BAnimation%26length_seconds%3D31%26id%3DFP9xp6S5MAY%26session_data%3Ditct%253DMgllbmRzY3JlZW5IqMe06_zV1Okl%2Cauthor%3DHD%2BBacks%26id%3DSLrpzRvQDfw%26length_seconds%3D21%26title%3DClean%2BFuture%2B-%2BHD%2BMotion%2BGraphics%2BBackground%2BLoop%26session_data%3Ditct%253DMgllbmRzY3JlZW5IqMe06_zV1Okl%26iurlhq_webp%3D%252F%252Fi.ytimg.com%252Fvi_webp%252FSLrpzRvQDfw%252Fhqdefault.webp%26iurlmq_webp%3D%252F%252Fi.ytimg.com%252Fvi_webp%252FSLrpzRvQDfw%252Fmqdefault.webp%2Csession_data%3Ditct%253DMgllbmRzY3JlZW5IqMe06_zV1Okl%26playlist_length%3D192%26video_id%3DFwy4fPoInH4%26playlist_title%3DBEST%2BCOMPILATION%2B4K%2BBackground%2BEffects%2BSparkles%2B%2526%2BShine%2BAnimation%2BLoop%2BUHD%2B%2BHD%2B1080p%2BUHD%2B2160p%2B%2BRoyalty%2BFree%2BFootage%26list%3DPLj6XzcqwRpN4eUUun6Y0ktAIdNiy3FN-e%26thumbnail_ids%3DFwy4fPoInH4%2Cauthor%3DAA%2BVFX%26title%3D60FPS%2B4K%2BFlare%2BTunnel%2BAnimation%26length_seconds%3D21%26id%3Dm3uJlyhXRJA%26session_data%3Ditct%253DMgllbmRzY3JlZW5IqMe06_zV1Okl%2Cauthor%3DScience%2BFor%2Bthe%2BWin%26id%3DRQm6N60bneo%26length_seconds%3D5489%26title%3DThe%2BHistory%2Bof%2BEarth%2B%2528HD%2B-%2B720P%2529%26session_data%3Ditct%253DMgllbmRzY3JlZW5IqMe06_zV1Okl%26iurlhq_webp%3D%252F%252Fi.ytimg.com%252Fvi_webp%252FRQm6N60bneo%252Fhqdefault.webp%26iurlmq_webp%3D%252F%252Fi.ytimg.com%252Fvi_webp%252FRQm6N60bneo%252Fmqdefault.webp%2Cauthor%3DAA%2BVFX%26id%3DqnoMmbEXzzQ%26length_seconds%3D33%26title%3D4K%2BColorful%2BHypnotic%2BMirror%2BEffect%2BAnimation%2B2160p%2BBackground%26session_data%3Ditct%253DMgllbmRzY3JlZW5IqMe06_zV1Okl%26iurlhq_webp%3D%252F%252Fi.ytimg.com%252Fvi_webp%252FqnoMmbEXzzQ%252Fhqdefault.webp%26iurlmq_webp%3D%252F%252Fi.ytimg.com%252Fvi_webp%252FqnoMmbEXzzQ%252Fmqdefault.webp%2Cauthor%3DAA%2BVFX%26id%3D3L2hToutnWw%26length_seconds%3D31%26title%3D4K%2BTitle%2BBars%2Bor%2BMenu%2BDesign%2BWelcome%2BScreen%2B2160p%2BAnimation%2BWallpaper%26session_data%3Ditct%253DMgllbmRzY3JlZW5IqMe06_zV1Okl%26iurlhq_webp%3D%252F%252Fi.ytimg.com%252Fvi_webp%252F3L2hToutnWw%252Fhqdefault.webp%26iurlmq_webp%3D%252F%252Fi.ytimg.com%252Fvi_webp%252F3L2hToutnWw%252Fmqdefault.webp%2Cauthor%3DAA%2BVFX%26id%3D6T5LlkZ9NAA%26length_seconds%3D60%26title%3D4K%2BShining%2BOrange%2BGlow%2BUHD%2BHD%2BBackground%2BAnimation%26session_data%3Ditct%253DMgllbmRzY3JlZW5IqMe06_zV1Okl%26iurlhq_webp%3D%252F%252Fi.ytimg.com%252Fvi_webp%252F6T5LlkZ9NAA%252Fhqdefault.webp%26iurlmq_webp%3D%252F%252Fi.ytimg.com%252Fvi_webp%252F6T5LlkZ9NAA%252Fmqdefault.webp%2Cauthor%3DMatthiasM.de%26id%3D0pXYp72dwl0%26length_seconds%3D84%26title%3DEntering%2BThe%2BStronghold%2B%257C%2BAudio%2BVisual%2BAnimation%2B%2B%2B%2BHD%2521%26session_data%3Ditct%253DMgllbmRzY3JlZW5IqMe06_zV1Okl%26iurlhq_webp%3D%252F%252Fi.ytimg.com%252Fvi_webp%252F0pXYp72dwl0%252Fhqdefault.webp%26iurlmq_webp%3D%252F%252Fi.ytimg.com%252Fvi_webp%252F0pXYp72dwl0%252Fmqdefault.webp&amp;fade_in_duration_milliseconds=1000&amp;use_cipher_signature=False&amp;watermark=%2Chttps%3A%2F%2Fs.ytimg.com%2Fyts%2Fimg%2Fwatermark%2Fyoutube_watermark-vflHX6b6E.png%2Chttps%3A%2F%2Fs.ytimg.com%2Fyts%2Fimg%2Fwatermark%2Fyoutube_hd_watermark-vflAzLcD6.png&amp;probe_url=https%3A%2F%2Fr1---sn-p5qlsnsr.googlevideo.com%2Fvideogoodput%3Fid%3Do-AG8Is-QbcFHYoJoL3ufAqoJ0rBezH4482ZwzrhHADwDX%26source%3Dgoodput%26range%3D0-4999%26expire%3D1432468131%26ip%3D89.228.194.99%26ms%3Dpm%26mm%3D35%26pl%3D24%26nh%3DIgpwcjAxLmlhZDA3KgkxMjcuMC4wLjE%26sparams%3Did%2Csource%2Crange%2Cexpire%2Cip%2Cms%2Cmm%2Cpl%2Cnh%26signature%3D137A640D9AEE6FCC692E5D3E96923B4401DCB613.29778098E3230A321E2E54387528FB10FD79E9FA%26key%3Dcms1&amp;apply_fade_on_midrolls=True&amp;adsense_video_doc_id=yt_JdNSr81tI6g&amp;show_content_thumbnail=True&amp;ad_device=1&amp;allow_html5_ads=1&amp;no_get_video_log=1&amp;storyboard_spec=https%3A%2F%2Fi.ytimg.com%2Fsb%2FJdNSr81tI6g%2Fstoryboard3_L%24L%2F%24N.jpg%7C48%2327%23100%2310%2310%230%23default%23E6sl2ZM2Wl-Trx0mWXDEpOXk7bw%7C80%2345%2361%2310%2310%231000%23M%24M%23rWiWoYlo8U0zVQjBroBMj6WmwFY%7C160%2390%2361%235%235%231000%23M%24M%23UO29M2OfWs-1AaqlQu0WO2QpUew&amp;timestamp=1432464531&amp;shortform=True&amp;ad_flags=0&amp;enablecsi=1&amp;excluded_ads=3%3D1_1%2C1_2_1%2C1_3%2C2_2_1%2C2_3%3B10%3D14_14%3B46%3D14_14&amp;fade_out_start_milliseconds=0&amp;cafe_experiment_id=56702370&amp;tmi=1&amp;tag_for_child_directed=False&amp;ypc_ad_indicator=4&amp;loeid=901803%2C913445%2C9408289&amp;cl=94162627&amp;dbp=ChoKFm9XQ3JCUGhVYkhjNUUxSkR0Z2RvUWcQARgC&amp;thumbnail_url=https%3A%2F%2Fi.ytimg.com%2Fvi%2FJdNSr81tI6g%2Fdefault.jpg&amp;ptchn=ilPIl-SwFbtsoH8WLnvlfA&amp;midroll_freqcap=420.0&amp;ad_module=https%3A%2F%2Fs.ytimg.com%2Fyts%2Fswfbin%2Fplayer-vflwYITrz%2Fad.swf&amp;ptk=ilPIl-SwFbtsoH8WLnvlfA&amp;iv_module=https%3A%2F%2Fs.ytimg.com%2Fyts%2Fswfbin%2Fplayer-vflwYITrz%2Fiv_module.swf&amp;adaptive_fmts=clen%3D62123176%26lmt%3D1425385785868854%26size%3D3840x2160%26fps%3D30%26itag%3D266%26init%3D0-710%26url%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D59.959%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D62123176%2526gir%253Dyes%2526mime%253Dvideo%25252Fmp4%2526key%253Dyt5%2526itag%253D266%2526lmt%253D1425385785868854%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253D84D612254F0BE774CB1EEC922AB460057647D971.5112996B6ED45DFF8F844CA4ABC10FC29E91EDB6%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26projection_type%3D1%26bitrate%3D9158316%26index%3D711-886%26type%3Dvideo%252Fmp4%253B%2Bcodecs%253D%2522avc1.640033%2522%2Cclen%3D42208228%26lmt%3D1424693461355041%26size%3D3840x2160%26fps%3D30%26itag%3D313%26init%3D0-242%26url%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D59.927%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D42208228%2526gir%253Dyes%2526mime%253Dvideo%25252Fwebm%2526key%253Dyt5%2526itag%253D313%2526lmt%253D1424693461355041%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253D7D3D7AD818418F8A9890710E029FD82D4AAF652F.4C703EB3741A7E0BDEF9CAEAFFE484B5261BA6FF%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26projection_type%3D1%26bitrate%3D5844980%26index%3D243-445%26type%3Dvideo%252Fwebm%253B%2Bcodecs%253D%2522vp9%2522%2Cclen%3D23808347%26lmt%3D1425386336655183%26size%3D2560x1440%26fps%3D30%26itag%3D264%26init%3D0-710%26url%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D59.959%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D23808347%2526gir%253Dyes%2526mime%253Dvideo%25252Fmp4%2526key%253Dyt5%2526itag%253D264%2526lmt%253D1425386336655183%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253DA5FF6607973F915360C6F0318D3BF10342C1882F.4470D7D3C31FAC3B7061E6059413D788CF40133A%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26projection_type%3D1%26bitrate%3D3536214%26index%3D711-886%26type%3Dvideo%252Fmp4%253B%2Bcodecs%253D%2522avc1.640032%2522%2Cclen%3D16452834%26lmt%3D1424692961128064%26size%3D2560x1440%26fps%3D30%26itag%3D271%26init%3D0-242%26url%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D59.927%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D16452834%2526gir%253Dyes%2526mime%253Dvideo%25252Fwebm%2526key%253Dyt5%2526itag%253D271%2526lmt%253D1424692961128064%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253D0573EE1997BB37EC154C932AEB16ABA1964C6834.FA096E1BA5E2F3C1BFD00059697F985A4A0059B2%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26projection_type%3D1%26bitrate%3D2390788%26index%3D243-438%26type%3Dvideo%252Fwebm%253B%2Bcodecs%253D%2522vp9%2522%2Cclen%3D12116926%26lmt%3D1425384888365226%26size%3D1920x1080%26fps%3D30%26itag%3D137%26init%3D0-710%26url%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D59.959%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D12116926%2526gir%253Dyes%2526mime%253Dvideo%25252Fmp4%2526key%253Dyt5%2526itag%253D137%2526lmt%253D1425384888365226%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253D5E129379579229B31CCEA2241724FEB64B8EEA43.2AAB322884056B49F3EB1C98CAFBC9177C29CFA1%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26projection_type%3D1%26bitrate%3D1798240%26index%3D711-886%26type%3Dvideo%252Fmp4%253B%2Bcodecs%253D%2522avc1.640028%2522%2Cclen%3D6322493%26lmt%3D1424692797264753%26size%3D1920x1080%26fps%3D30%26itag%3D248%26init%3D0-242%26url%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D59.927%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D6322493%2526gir%253Dyes%2526mime%253Dvideo%25252Fwebm%2526key%253Dyt5%2526itag%253D248%2526lmt%253D1424692797264753%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253D029196EC949B3FDCC6ECD2F233FB7DD9812C9365.7B7DD4F37436D671D86768A679E8EFC38D02A0CC%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26projection_type%3D1%26bitrate%3D885493%26index%3D243-438%26type%3Dvideo%252Fwebm%253B%2Bcodecs%253D%2522vp9%2522%2Cclen%3D6967176%26lmt%3D1425384773090191%26size%3D1280x720%26fps%3D30%26itag%3D136%26init%3D0-708%26url%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D59.959%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D6967176%2526gir%253Dyes%2526mime%253Dvideo%25252Fmp4%2526key%253Dyt5%2526itag%253D136%2526lmt%253D1425384773090191%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253DCE196AB79390E817BD0564CC2A54F91A50E2F9C8.61EA5FE52A420535B278C2C158BA77E9C6777C80%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26projection_type%3D1%26bitrate%3D991092%26index%3D709-884%26type%3Dvideo%252Fmp4%253B%2Bcodecs%253D%2522avc1.4d401f%2522%2Cclen%3D3323122%26lmt%3D1424692708575265%26size%3D1280x720%26fps%3D30%26itag%3D247%26init%3D0-242%26url%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D59.927%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D3323122%2526gir%253Dyes%2526mime%253Dvideo%25252Fwebm%2526key%253Dyt5%2526itag%253D247%2526lmt%253D1424692708575265%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253D80C5AF8B69EE6C1E0D9BCCB136939BD9994B798C.1C74B844641AF331D3BBAF5080C19DB7017F283B%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26projection_type%3D1%26bitrate%3D479753%26index%3D243-438%26type%3Dvideo%252Fwebm%253B%2Bcodecs%253D%2522vp9%2522%2Cclen%3D3894301%26lmt%3D1425384794518635%26size%3D854x480%26fps%3D30%26itag%3D135%26init%3D0-708%26url%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D59.959%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D3894301%2526gir%253Dyes%2526mime%253Dvideo%25252Fmp4%2526key%253Dyt5%2526itag%253D135%2526lmt%253D1425384794518635%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253DEAF26E15268F73D482A2B696023502CEF88DA7D8.8C6529CB218169D399191352339D40762A2D483A%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26projection_type%3D1%26bitrate%3D526601%26index%3D709-884%26type%3Dvideo%252Fmp4%253B%2Bcodecs%253D%2522avc1.4d401f%2522%2Cclen%3D1669143%26lmt%3D1424692692556776%26size%3D854x480%26fps%3D30%26itag%3D244%26init%3D0-242%26url%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D59.927%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D1669143%2526gir%253Dyes%2526mime%253Dvideo%25252Fwebm%2526key%253Dyt5%2526itag%253D244%2526lmt%253D1424692692556776%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253D4090C921513F078A1E7E2D7659989E9AB4D6C5FD.D038DE8190013163FF6633700870B9142FD3BDA9%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26projection_type%3D1%26bitrate%3D239681%26index%3D243-438%26type%3Dvideo%252Fwebm%253B%2Bcodecs%253D%2522vp9%2522%2Cclen%3D1838440%26lmt%3D1425384763475577%26size%3D640x360%26fps%3D30%26itag%3D134%26init%3D0-708%26url%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D59.959%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D1838440%2526gir%253Dyes%2526mime%253Dvideo%25252Fmp4%2526key%253Dyt5%2526itag%253D134%2526lmt%253D1425384763475577%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253D57BD4AF95FE8CAAD195EE57CD7FFC01C1D85B0A0.DDC79833AD90FAB03CDCDAF38155187F76EA55EB%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26projection_type%3D1%26bitrate%3D253349%26index%3D709-884%26type%3Dvideo%252Fmp4%253B%2Bcodecs%253D%2522avc1.4d401e%2522%2Cclen%3D1023717%26lmt%3D1424692669616490%26size%3D640x360%26fps%3D30%26itag%3D243%26init%3D0-242%26url%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D59.927%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D1023717%2526gir%253Dyes%2526mime%253Dvideo%25252Fwebm%2526key%253Dyt5%2526itag%253D243%2526lmt%253D1424692669616490%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253DCCD1F4CFE4BDE76FA120D69F444CF06EB7D7F843.076E699F82F5D77B34CF5391547C16877FEA5C33%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26projection_type%3D1%26bitrate%3D147478%26index%3D243-438%26type%3Dvideo%252Fwebm%253B%2Bcodecs%253D%2522vp9%2522%2Cclen%3D1825443%26lmt%3D1425384740894315%26size%3D426x240%26fps%3D30%26itag%3D133%26init%3D0-672%26url%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D59.959%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D1825443%2526gir%253Dyes%2526mime%253Dvideo%25252Fmp4%2526key%253Dyt5%2526itag%253D133%2526lmt%253D1425384740894315%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253D9DD621EAEB45F1EDFD07C840059888D87F380AF4.C7FA27109177DDD7E7FB2B2F86DC30141EC53C8A%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26projection_type%3D1%26bitrate%3D244748%26index%3D673-848%26type%3Dvideo%252Fmp4%253B%2Bcodecs%253D%2522avc1.4d4015%2522%2Cclen%3D523530%26lmt%3D1424692654384242%26size%3D426x240%26fps%3D30%26itag%3D242%26init%3D0-241%26url%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D59.927%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D523530%2526gir%253Dyes%2526mime%253Dvideo%25252Fwebm%2526key%253Dyt5%2526itag%253D242%2526lmt%253D1424692654384242%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253DA708FB99747318556B72573ABA627A1258D3924E.CA032D8E973BEE0886E18952E53D4784B5E9F873%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26projection_type%3D1%26bitrate%3D76382%26index%3D242-436%26type%3Dvideo%252Fwebm%253B%2Bcodecs%253D%2522vp9%2522%2Cclen%3D819288%26lmt%3D1425384755348428%26size%3D256x144%26fps%3D15%26itag%3D160%26init%3D0-670%26url%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D59.993%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D819288%2526gir%253Dyes%2526mime%253Dvideo%25252Fmp4%2526key%253Dyt5%2526itag%253D160%2526lmt%253D1425384755348428%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253DB36B3B83FDD5CD464BCB786C3C4B2ACABB7ABA6D.5A4843C1207C2B82E1945AFAB1A31AC4EED37785%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26projection_type%3D1%26bitrate%3D110376%26index%3D671-846%26type%3Dvideo%252Fmp4%253B%2Bcodecs%253D%2522avc1.4d400c%2522%2Curl%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D60.023%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D964342%2526gir%253Dyes%2526mime%253Daudio%25252Fmp4%2526key%253Dyt5%2526itag%253D140%2526lmt%253D1425378026597616%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253D6631F71DD897010E9AF7DC0426F665D5285D10E0.EBD0ACFA6AFB88EB5D3B8D487D1048C629937179%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26type%3Daudio%252Fmp4%253B%2Bcodecs%253D%2522mp4a.40.2%2522%26itag%3D140%26index%3D592-707%26clen%3D964342%26bitrate%3D163130%26lmt%3D1425378026597616%26init%3D0-591%26projection_type%3D1%2Curl%3Dhttps%253A%252F%252Fr8---sn-h0auphxqp5-f5fe.googlevideo.com%252Fvideoplayback%253Fmm%253D31%2526pl%253D18%2526id%253Do-AK96s8-2aX891JHybSHHh3437LJ-a63QYgT3Jd61tP03%2526dur%253D59.944%2526requiressl%253Dyes%2526ip%253D89.228.194.99%2526mt%253D1432464497%2526mv%253Dm%2526ms%253Dau%2526fexp%253D3300109%25252C3300131%25252C3300137%25252C3312210%25252C3312381%25252C901803%25252C913445%25252C9408142%25252C9408289%25252C9408710%25252C9413503%25252C9415304%25252C948124%25252C952612%2526upn%253DP6mj1AtKVKI%2526clen%253D22729%2526gir%253Dyes%2526mime%253Daudio%25252Fwebm%2526key%253Dyt5%2526itag%253D171%2526lmt%253D1424692629538384%2526sver%253D3%2526source%253Dyoutube%2526initcwndbps%253D1538750%2526signature%253D810A4379305C230B5D50A93B8652F20C6C9F907C.6D36D5545A41B88E6F557726C3BAAF723BAC73C1%2526sparams%253Dclen%25252Cdur%25252Cgir%25252Cid%25252Cinitcwndbps%25252Cip%25252Cipbits%25252Citag%25252Clmt%25252Cmime%25252Cmm%25252Cms%25252Cmv%25252Cpl%25252Crequiressl%25252Csource%25252Cupn%25252Cexpire%2526ipbits%253D0%2526expire%253D1432486131%26type%3Daudio%252Fwebm%253B%2Bcodecs%253D%2522vorbis%2522%26itag%3D171%26index%3D4452-4545%26clen%3D22729%26bitrate%3D6060%26lmt%3D1424692629538384%26init%3D0-4451%26projection_type%3D1&amp;is_listed=1&amp;token=sSPRzi9D_lXoq1PiZSb9GJ3l-U6WqPtcmxEykk062Z4%3D&amp;fade_out_duration_milliseconds=1000&amp;iv_load_policy=1&amp;muted=0&amp;iv_allow_in_place_switch=1&amp;midroll_prefetch_size=1&amp;author=AA%20VFX&amp;ad_slots=0&amp;iv_invideo_url=https%3A%2F%2Fwww.youtube.com%2Fannotations_invideo%3Fcap_hist%3D1%26video_id%3DJdNSr81tI6g&amp;iv3_module=1&amp;cid=8211322&amp;mpvid=aDfJ7Q6W60JPrsrt&amp;as_launched_in_country=1&amp;loudness=-90.3089981079&amp;account_playback_token=QUFFLUhqbUR3SEgwQTlXeW9ZQjJ3b2F1ci1vZUJNSGZxZ3xBQ3Jtc0trQmllTkZWNFVXN0dJaTZ5NjBOUGlGQjVZOWRIQnVSejdqZ0lEdjRSaGVGTmgtUy1RS0lWanRrajBYMlJSLXY3VV9nNmdOdGNYcHpzNGdZRHFXNC1welJFT1E4SjFzM2laMVV6cTVTY0FjZnBzVEd4cw%3D%3D&amp;fmt_list=22%2F1280x720%2F9%2F0%2F115%2C43%2F640x360%2F99%2F0%2F0%2C18%2F640x360%2F9%2F0%2F115%2C5%2F426x240%2F7%2F0%2F0%2C36%2F426x240%2F99%2F1%2F0%2C17%2F256x144%2F99%2F1%2F0&amp;start=23.78125&amp;autoplay=1&amp;html5_unavailable=1"
      flashData = unescape(flashDataUri)
      #console.log 'flashData',flashData
      flashParams = flashData.split('&')
      #console.log 'flashParams',flashParams
      parsedParams = {}
      for param in flashParams
        [key,value] = param.split('=')
        parsedParams[key]=unescape(value)
      console.log parsedParams
      ###

      @formats = {}
      for adaptive in @adaptiveStreams
        itag = adaptive.itag
        @formats[itag] = adaptive
        @formats[itag].urlDecoded = unescape(adaptive.url)
        urlDec = @formats[itag].urlDecoded
        [url,paramStr] = /^https?\:\/\/[^?]+\?(.*)$/gi.exec(urlDec)
        params = paramStr.split('&')
        urlParams={}
        for param in params
          [key,value]=param.split('=')
          urlParams[key]=unescape(value)
        @formats[itag].urlParams = urlParams

      console.log 'formats finished',@formats
      @emitter.emit 'formats',@formats
      @emitter.emit 'ready'
      if next?
        next(@formats)
      

  parseRange:(range)->
    if range?
      [start,end] = range.split('-')
      startMs = @parseTime(start)
      endMs = @parseTime(end)
      if not stratS<endS
        console.error 'Range is invalid'
        return
      [startMs,endMs]


  timeToBytes:(ms)->
    format = @formats[@itag]
    oneMs = format.clen / (format.urlParams.dur * 1000)
    result = Math.round(oneMs * ms) // 1024 * 1024
    console.log 'ms,oneMs,result',ms,oneMs,result
    result

  getBytesRange:(range,next)->
    url = @formats[@itag].urlDecoded+'&range='+range
    console.log 'getting range',range
    host =  /^https?\:\/\/([^\/]+)\/.*/gi.exec(url)
    console.log 'host',host[1]
    reqObj = {url:url,headers:{'Host':host[1]},encoding:'binary'}
    #request(reqObj).pipe(@fileStream)
    
    request reqObj,(err,res,body)=>
      console.log 'is buffer?',Buffer.isBuffer(body)
      if res.headers['content-type']=='text/plain'
        @formats[@itag].url = body
        @getBytesRange range,next
        return
      if not Buffer.isBuffer(body)
        buffSize = parseInt(res.headers['content-length'])
        console.log 'buffSize',buffSize
        buff = new Buffer(buffSize,'binary')
        buff.write body,'binary'
        body = buff
      
      result = {bytes:body,size:parseInt(res.headers['content-length'])}
      console.log 'received bytes',result.size,res.headers['content-length']
      @emitter.emit 'data',result
      @saveBytes result,next
  
  getTimeRange: (timeRange,next) ->
    url = @formats[@itag].urlDecoded+'&start='+timeRange.start.toString()
    console.log 'getting range',timeRange
    host =  /^https?\:\/\/([^\/]+)\/.*/gi.exec(url)
    console.log 'host',host[1]
    reqObj = {url:url,headers:{'Host':host[1]},encoding:'binary'}
    #request(reqObj).pipe(@fileStream)
    
    request reqObj,(err,res,body)=>
      console.log 'is buffer?',Buffer.isBuffer(body)
      if res.headers['content-type']=='text/plain'
        @formats[@itag].url = body
        @getBytesRange range,next
        return
      if not Buffer.isBuffer(body)
        buffSize = parseInt(res.headers['content-length'])
        console.log 'buffSize',buffSize
        buff = new Buffer(buffSize,'binary')
        buff.write body,'binary'
        body = buff
      
      result = {bytes:body,size:parseInt(res.headers['content-length'])}
      console.log 'received bytes',result.size,res.headers['content-length']
      @emitter.emit 'data',result
      @savedBytes+=result.size



  saveBytes:(result,next)->
    @savedBytes+=result.size
    @currentChunk++
    console.log 'chunk:',@currentChunk,'allBytes:',@savedBytes
    if @currentChunk >= Math.ceil( @chunks ) #finished -last chunk
      @fileStream.end result.bytes,'binary',(err)=>
        if err?
          console.error 'Cannot save the file'
          return
        @emitter.emit 'done'
        if next? then next()
    else #not finished yet
      @fileStream.write result.bytes,'binary',(err)=>
        if err?
          console.error 'Cannot save the file'
          return
      start = @savedBytes
      if @currentChunk >= Math.floor( @chunks )
        leftBytes = @endByte - (65535 * Math.floor( @chunks ))
        end = start + leftBytes
      else
        end = start + 65535
      rangeStr = start.toString()+'-'+end.toString()

  toInt32:(array)->
    arr = []
    for i in [0..3]
      arr[i]=array[3-i]
    int32 = new Uint8Array(arr)[0]
    int32
  
  toStr:(array)->
    console.log 'toStr',array
    str = ''
    len = array.length || array.byteLength
    for i in [0..len-1]
      str += String.fromCharCode(array[i])
    str


  getHeader:(next)->
    initRange = @formats[@itag].init.split('-')
    indexRange = @formats[@itag].index.split('-')
    range = '0-'+indexRange[1]
    url = @formats[@itag].urlDecoded+'&range='+range
    console.log 'init',url
    host =  /^https?\:\/\/([^\/]+)\/.*/gi.exec(url)
    reqObj = {url:url,headers:{'Host':host[1]},encoding:'binary'}
    request reqObj,(err,res,body)=>
    
      buff = new Uint8Array(body.length)
      text = ''
      for i in [0..body.length]
        buff[i]=body.charCodeAt(i)
      box = mp4.parseBuffer(buff.buffer)
      @sidx = box.fetch('sidx')
      @references = @sidx.references
      @ranges = []
      offset = parseInt(initRange[1])+1 # end of header
      time = 0
      for reference in @references
        range = {
          startByte: offset,
          endByte: offset + reference.referenced_size-1,
          startTime: time,
          endTime: time+reference.subsegment_duration-1,
          size: reference.referenced_size,
          duration: reference.subsegment_duration
        }
        @ranges.push range
        offset  += reference.referenced_size
        time += reference.subsegment_duration
      console.log @ranges
      next(@ranges)



  # range = 10s-20s or 1h10m0s-1h15m0s
  download:(obj)->
    console.log 'download',obj

    if obj.filename?
      @filename = obj.filename
    else
      console.error 'no filename specified'
      return

    if !obj.itag?
      console.error 'No format specified'
      return

    @itag = obj.itag
    if !@formats[@itag]?
      console.error 'Wrong format specified'
      return

    @getHeader (ranges)=>      
      @start = 0
      @end = @parseTime("10s")
      @savedBytes = 0
      @currentChunk = 0

      if obj.start?
        @start = @parseTime(obj.start)
      if obj.end?
        @end = @parseTime(obj.end)

      @startByte = @timeToBytes(@start)
      @endByte = @timeToBytes(@end)
      byteRange = @startByte.toString()+'-'+@endByte.toString()
      console.log byteRange
      @durationBytes = @endByte - @startByte
      @chunks = @durationBytes / 65535
      console.log 'chunks',@chunks
      firstRange = @startByte.toString()+'-'+(parseInt(@startByte)+65535).toString()
      console.log 'firstRange',firstRange
      @fileStream = fs.createWriteStream(@filename)
      
      if @startByte!=0
        @getHeader (buffer)=>
          @fileStream.write buffer,'binary',(err)=>
            if !err?
              @getBytesRange firstRange
            else
              console.error err
      else
        @getBytesRange firstRange



  destroy:->
    @emitter.dispose()

module.exports = YouTube
